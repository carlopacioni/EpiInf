<beast version="2.0" namespace="beast.core
    :beast.core.parameter
    :beast.core.util
    :beast.evolution.likelihood
    :beast.evolution.operators
    :epiinf
    :epiinf.models
    :epiinf.distribs
    :epiinf.util
    :feast.mapping">


    <tree spec="SimulatedTransmissionTree" id="simulated_tree" fileName="$(filebase)_truth.tree">
        <epidemicTrajectory spec="SimulatedTrajectory" maxDuration="7.0" fileName="$(filebase)_truth.traj">
            <model spec="BirthDeathModel">
                <birthRate spec="RealParameter" value="1.0"/>
                <deathRate spec="RealParameter" value="0.2"/>
                <psiSamplingRate spec="RealParameter" value="0.2"/>
                <!--rhoSamplingProb spec="RealParameter" value="0.5"/>
                <rhoSamplingTime spec="RealParameter" value="4.0"/-->
            </model>
        </epidemicTrajectory>
    </tree>

    <alignment id="alignment" spec="epiinf.SimulatedAlignment" tree="@simulated_tree" sequenceLength="2000">
        <siteModel id="siteModel" spec="beast.evolution.sitemodel.SiteModel">
            <substModel spec="beast.evolution.substitutionmodel.JukesCantor"/>
            <mutationRate spec="RealParameter" value="0.005"/>
        </siteModel>
    </alignment>

    <run spec="MCMC" id="mcmc" chainLength="100000">
        <state>
            <!--stateNode id="tree" spec="beast.evolution.tree.RandomTree" taxa="@alignment">
                <populationModel spec="beast.evolution.tree.coalescent.ConstantPopulation" popSize="0.1"/>
                <trait spec='TipDatesFromTree' tree="@simulated_tree">
                    <taxa spec='beast.evolution.alignment.TaxonSet' alignment="@alignment"/>
                </trait>
            </stateNode-->
            <stateNode id="tree" spec="beast.util.ClusterTree" taxa="@alignment" clusterType="upgma">
                <trait spec='TipDatesFromTree' tree="@simulated_tree">
                    <taxa spec='beast.evolution.alignment.TaxonSet' alignment="@alignment"/>
                </trait>
            </stateNode>
            <stateNode id="birthRate" spec="RealParameter" value="1.0"/>
            <stateNode id="deathRate" spec="RealParameter" value="0.2"/>
            <stateNode id="psiSamplingRate" spec="RealParameter" value="0.2"/>
            <stateNode id="origin" spec="RealParameter" value="10.0"/>
        </state>

        <distribution id="posterior" spec="CompoundDistribution">

            <distribution spec="TreeLikelihood" id="treeLikelihood" siteModel="@siteModel">
                <data idref="alignment"/>
                <tree idref="tree"/>
            </distribution>

            <distribution spec="SMCTreeDensity" id="treePrior" nParticles="100" trajRecordPeriod="100">
                <treeEventList spec="TreeEventList" treeOrigin="@origin" tree="@tree"/>
                <model spec="BirthDeathModel">
                    <birthRate idref="birthRate" />
                    <deathRate idref="deathRate" />
                    <psiSamplingRate idref="psiSamplingRate" />
                </model>
            </distribution>

            <distribution spec="CompoundDistribution" id="paramPriors">
                <distribution spec="beast.math.distributions.Prior" x="@origin">
                    <distr spec="beast.math.distributions.OneOnX"/>
                </distribution>
                <distribution spec="beast.math.distributions.Prior" x="@birthRate">
                    <distr spec="beast.math.distributions.OneOnX"/>
                </distribution>
                <distribution spec="beast.math.distributions.Prior" x="@deathRate">
                    <distr spec="beast.math.distributions.OneOnX"/>
                </distribution>
                <distribution spec="beast.math.distributions.Prior" x="@psiSamplingRate">
                    <distr spec="beast.math.distributions.OneOnX"/>
                </distribution>
            </distribution>
        </distribution>

        <operator id='birthRateScaler' spec='ScaleOperator' scaleFactor="0.8" weight="1">
            <parameter idref="birthRate"/>
        </operator>
        <operator id='deathRateScaler' spec='ScaleOperator' scaleFactor="0.8" weight="1">
            <parameter idref="deathRate"/>
        </operator>
        <operator id='samplingRateScaler' spec='ScaleOperator' scaleFactor="0.8" weight="1">
            <parameter idref="psiSamplingRate"/>
        </operator>

        <operator id='originScaler' spec='ScaleOperator' scaleFactor="0.8" weight="1">
            <parameter idref="origin"/>
        </operator>

        <operator id='treeScaler' spec='ScaleOperator' scaleFactor="0.5" weight="1">
            <tree idref="tree"/>
        </operator>

        <operator id='treeUpDown' spec='UpDownOperator' scaleFactor="0.8" weight="1">
            <up idref="tree"/>
            <up idref="origin"/>
            <down idref="birthRate"/>
            <down idref="deathRate"/>
            <down idref="psiSamplingRate"/>
        </operator>

        <operator spec='Uniform' weight="10">
            <tree idref="tree"/>
        </operator>
        <operator spec='SubtreeSlide' weight="5" gaussian="true" size="1.0">
            <tree idref="tree"/>
        </operator>
        <operator id='narrow' spec='Exchange' isNarrow='true' weight="1">
            <tree idref="tree"/>
        </operator>
        <operator id='wide' spec='Exchange' isNarrow='false' weight="1">
            <tree idref="tree"/>
        </operator>
        <operator spec='WilsonBalding' weight="1">
            <tree idref="tree"/>
        </operator>


        <logger id="screenlog" spec="Logger" logEvery="1000">
            <log idref="posterior"/>
            <log idref="birthRate"/>
            <log idref="deathRate"/>
            <log idref="psiSamplingRate"/>
            <log idref="origin"/>
        </logger>

        <logger logEvery="1000" fileName="$(filebase).trees">
            <log idref="tree"/>
        </logger>

        <logger logEvery="100" fileName="$(filebase).traj">
            <log spec='TrajectoryLogger' treeDensity="@treePrior" />
        </logger>

        <logger id="filelog" spec="Logger" logEvery="1000" fileName="$(filebase).log">
            <log idref="posterior"/>
            <log idref="birthRate"/>
            <log idref="deathRate"/>
            <log idref="psiSamplingRate"/>
            <log idref="origin"/>
        </logger>
    </run>
</beast>
